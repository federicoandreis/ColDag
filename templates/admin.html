{% extends "base.html" %}

{% block content %}
<h1>Admin Dashboard</h1>

<h2>User Management</h2>
<a href="{{ url_for('user_activity') }}">View User Activity Log</a>
<table>
    <thead>
        <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Admin</th>
            <th>Created At</th>
            <th>Last Login</th>
            <th>Active</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
    {% for user in users %}
        <tr>
            <td>{{ user.username }}</td>
            <td>{{ user.email }}</td>
            <td>
                <form method="POST" action="{{ url_for('change_user_role', user_id=user.id) }}">
                    <select name="role_id" onchange="this.form.submit()">
                        {% for role in roles %}
                            <option value="{{ role.id }}" {% if user.role_id == role.id %}selected{% endif %}>
                                {{ role.name }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
            </td>
            <td>{{ 'Yes' if user.is_admin else 'No' }}</td>
            <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M:%S') if user.last_login else 'Never' }}</td>
            <td>{{ 'Yes' if user.is_active else 'No' }}</td>
            <td>
                <a href="{{ url_for('toggle_admin', user_id=user.id) }}">Toggle Admin</a>
                <a href="{{ url_for('toggle_active', user_id=user.id) }}">Toggle Active</a>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<h2>All Projects</h2>
<button id="export-all-json">Export All JSON</button>
<ul>
{% for project in projects %}
    <li>
        <strong>{{ project.name }}</strong> (User: {{ project.user.username }})
        <br>Created: {{ project.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
        <br>Updated: {{ project.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}
        <pre>{{ project.content }}</pre>
    </li>
{% endfor %}
</ul>
<script>
document.getElementById('export-all-json').addEventListener('click', function() {
    window.location.href = '{{ url_for("export_all_graphs") }}';
});
</script>
{% endblock %}
